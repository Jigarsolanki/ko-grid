<!DOCTYPE html>
<html>
<head>
  <title>KO Grid</title>

  <script src="http://knockoutjs.com/downloads/knockout-3.0.0.js"></script>
</head>
<body>
  <div id="grid-container" data-bind="grid: $data"></div>

  <script type="application/javascript">

  /**

  [x] Render in basic forEach loop.
  [x] Render columns if specified.
  [x] Add header.
  [ ] Add sort handlers.
  [ ] Support single-row selection.
  [ ] Support multi-row selection.
  [ ] Use object properties as default column array.
  [ ] Extract templates to template factory (or layout).

  */

  function init(ele, value, bindings, model, context) {
    ko.renderTemplate('grid-template', value, {
      templateEngine: new ko.nativeTemplateEngine()
    }, ele);

    return { controlsDescendantBindings: true };
  }

  ko.bindingHandlers.grid = { init: init };

  kg = {};
  kg.grid = function (observable, columns) {
    var columnArray;

    columnArray = [];
    columns = columns || {};
    Object.keys(columns).forEach(function (key) {
      columnArray.push({ name: key, template: columns[key] });
    });

    return { data: observable, columns: columnArray };
  };

  document.addEventListener("DOMContentLoaded", function () {
    var i, data, grid, element;

    i = 1;
    data = ko.observableArray();
    grid = kg.grid(data, { 'name': 'text', 'count': 'link' });
    element = document.getElementById('grid-container');

    ko.applyBindings(grid, element);

    setInterval(function () {
      data.push({ name: ko.observable(i), count: ko.observable(i) });
      i += 1;
    }, 1000);

    setInterval(function () {
      var raw, index, element;

      raw = data();
      index = Math.floor(Math.random() * (raw.length));
      element = raw[index];
      element.name('Edited!');
    }, 5000);
  });

  </script>

  <script id="grid-template" type="text/html">

  <div class="grid">
    <div class="grid-row grid-row-header" data-bind="foreach: { data: columns, as: 'column' }">
      <span class="grid-cell grid-cell-header" data-bind="text: column.name"></span>
    </div>

    <!-- ko foreach: { data: data, as: 'row' } -->
    <div class="grid-row" data-bind="foreach: { data: $parent.columns, as: 'column' }">
      <span class="grid-cell" data-bind="text: row[column.name]"></span>
    </div>
    <!-- /ko -->
  </div>

  </script>
</body>
</html>
